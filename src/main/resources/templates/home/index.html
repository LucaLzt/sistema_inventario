<!doctype html>
<html lang="en" xmlns:th="http://www.thymeleaf.org" 
				xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
	<meta charset="UTF-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
	<title>Home</title>
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/css/bootstrap.min.css" rel="stylesheet">
	<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
</head>
<body>
    <!-- Navbar fragment -->
    <div th:replace="~{fragments/navbar :: navbar('home')}"></div>
	
	<!-- Principal Metrics -->
	<div class="container my-4">
	    <div class="row justify-content-center g-3">
	        <div class="col-12 col-md-6 col-lg-3">
	            <div class="card bg-primary bg-opacity-25 text-primary border-primary text-center shadow-sm">
	                <div class="card-body">
	                    <h4>Total Products</h4>
	                    <h2 class="fw-bold" th:text="${totalProducts}">-</h2>
	                </div>
	            </div>
	        </div>
	        <div class="col-12 col-md-6 col-lg-3">
	            <div class="card bg-success bg-opacity-25 text-success border-success text-center shadow-sm">
	                <div class="card-body">
	                    <h4>Stock Available</h4>
	                    <h2 class="fw-bold" th:text="${stockAvailable}">-</h2>
	                </div>
	            </div>
	        </div>
	        <div class="col-12 col-md-6 col-lg-3">
	            <div class="card bg-warning bg-opacity-25 text-warning border-warning text-center shadow-sm">
	                <div class="card-body">
	                    <h4>Low Stock</h4>
	                    <h2 class="fw-bold" th:text="${lowStock}">-</h2>
	                </div>
	            </div>
	        </div>
	        <div class="col-12 col-md-6 col-lg-3">
	            <div class="card bg-danger bg-opacity-25 text-danger border-danger text-center shadow-sm" id="cardTotalProducts">
	                <div class="card-body">
	                    <h4>Out of Stock</h4>
	                    <h2 class="fw-bold" th:text="${outOfStock}">-</h2>
	                </div>
	            </div>
	        </div>
	    </div>
	</div>
	
	<!-- Alerts and notifications -->
	<div class="container-fluid">
		<div class="row mb-4">
		    <div class="col-12">
		        <div class="alert alert-warning" th:if="${productsStockLow.size() > 0}">
		            <h5 class="ms-2">Products with low stock:</h5>
		            <ul class="mb-0">
		                <li th:each="product : ${productsStockLow}" 
		                    th:text="${product.name + ' (Mín Stock: ' + product.stockMinimum + ' - Actual Stock: ' + product.stockActual + ')'}">
		                </li>
		            </ul>
		        </div>
		    </div>
		</div>
	</div>
	
	<!-- Fast Access -->
	<div sec:authorize="hasRole('ADMIN')">
		<div class="container-fluid">
			<div class="row mb-4">
			    <div class="col-12">
			        <h4 class="mb-3">Quick Actions</h4>
			        <div class="d-flex gap-2 flex-wrap">
			            <button type="button" class="btn btn-outline-dark" data-bs-toggle="modal" data-bs-target="#modalAddProduct">
			                Add Product
			            </button>
			            <button type="button" class="btn btn-outline-dark" data-bs-toggle="modal" data-bs-target="#modalAddMovement">
			                Register Movement
			            </button>
			            <button type="button" class="btn btn-outline-dark" data-bs-toggle="modal" data-bs-target="#modalAddCategory">
			                Register Category
			            </button>
			        </div>
			    </div>
			</div>
		</div>
	</div>
	
	<!-- Recent Activity -->
	<div class="container-fluid">
		<div class="row">
		    <div class="col-md-6">
		        <div class="card">
		            <div class="card-header text-center">
		                <h5>Lastest Movements</h5>
		            </div>
		            <div class="card-body">
		                <div class="table-responsive">
		                    <table class="table table-sm text-center">
		                        <thead>
		                            <tr>
		                                <th>Date</th>
		                                <th>Product</th>
		                                <th>Type</th>
		                                <th>Amount</th>
		                            </tr>
		                        </thead>
		                        <tbody>
		                            <tr th:each="i : ${#numbers.sequence(0,4)}">
		                                <td th:text="${#lists.size(lastMovements) > i ? #temporals.format(lastMovements[i].movementDate, 'yyyy-MM-dd HH:mm') : '—' }"></td>
		                                <td th:text="${#lists.size(lastMovements) > i ? lastMovements[i].product.name : '—'}"></td>
		                                <td>
		                                    <span th:if="${#lists.size(lastMovements) > i}"
		                                    	  class="badge" 
		                                          th:classappend="${lastMovements[i].typeMovement.name() == 'IN' ? 'bg-success bg-opacity-75 text-dark' : 
		                                          				  (lastMovements[i].typeMovement.name() == 'OUT' ? 'bg-danger bg-opacity-75 text-dark' : 
		                                          				  (lastMovements[i].typeMovement.name() == 'ADJUSTMENT' ? 'bg-warning bg-opacity-75 text-dark' : 
		                                          				  'bg-secondary'))}"
		                                          th:text="${lastMovements[i].typeMovement}">
		                                    </span>
		                                    <span th:unless="${#lists.size(lastMovements) > i}">—</span>
		                                </td>
		                                <td th:text="${#lists.size(lastMovements) > i ? lastMovements[i].amount : '—'}"></td>
		                            </tr>
		                        </tbody>
		                    </table>
		                </div>
		            </div>
		        </div>
		    </div>
		    
		    <div class="col-md-6">
		        <div class="card">
		            <div class="card-header text-center">
		                <h5>Most Popular Products</h5>
		            </div>
		            <div class="card-body">
		                <div class="table-responsive">
		                    <table class="table table-sm text-center">
		                        <thead>
		                            <tr>
		                                <th>Product</th>
		                                <th>Actual Stock</th>
		                                <th>Movements</th>
		                            </tr>
		                        </thead>
		                        <tbody>
		                            <tr th:each="i : ${#numbers.sequence(0, 4)}">
		                                <td th:text="${#lists.size(mostMovedProducts) > i ? mostMovedProducts[i].product.name : '—'}"></td>
		                                <td th:text="${#lists.size(mostMovedProducts) > i ? mostMovedProducts[i].product.stockActual : '—'}"></td>
		                                <td>
		                                    <span class="badge bg-info bg-opacity-75 text-dark" 
		                                    	  th:text= "${#lists.size(mostMovedProducts) > i ? mostMovedProducts[i].totalMovements : '—'}">
		                                    </span>
		                                </td>
		                            </tr>
		                        </tbody>
		                    </table>
		                </div>
		            </div>
		        </div>
		    </div>
		</div>
	</div>
	
	<!-- Modals -->
	<div th:replace="~{fragments/product-modals :: modal-add-product(${categories}, 'home')}"></div>
	<div th:replace="~{fragments/movements-modals :: modal-add-movement(${products}, ${types}, ${branches}, 'home')}"></div>
	<div th:replace="~{fragments/category-modals :: modal-add-category}"></div>
	
	<!-- Script to show the add product modal if the flag is set -->
	<script th:if="${showAddProductModal}">
	    document.addEventListener('DOMContentLoaded', function() {
	        var modal = new bootstrap.Modal(document.getElementById('modalAddProduct'));
	        modal.show();
	    });
	</script>
	<!-- Script to show the add movement modal if the flag is set -->
	<script th:if="${showAddMovementModal}">
	    document.addEventListener('DOMContentLoaded', function() {
	        var modal = new bootstrap.Modal(document.getElementById('modalAddMovement'));
	        modal.show();
	    });
	</script>
	<!-- Script to show the add category modal if the flag is set -->
	<script th:if="${showAddCategoryModal}">
	    document.addEventListener('DOMContentLoaded', function() {
	        var modal = new bootstrap.Modal(document.getElementById('modalAddCategory'));
	        modal.show();
	    });
	</script>
	
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>