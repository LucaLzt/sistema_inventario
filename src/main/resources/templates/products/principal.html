<!doctype html>
<html lang="en" xmlns:th="http://www.thymeleaf.org"
				xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
	<meta charset="UTF-8"/>
	<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
	<title>Products - Inventory System</title>
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/css/bootstrap.min.css" rel="stylesheet">
	<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
</head>
<body>
	<!-- Navbar -->
	<div th:replace="~{fragments/navbar :: navbar('products')}"></div>
	
	<!-- Main Container -->
    <div class="main-container">
        
        <!-- Title -->
        <div class="functions-section">
            <h3 class="m-3">Products</h3>
        </div>
        
        <!-- Filter Section -->
        <div class="container-fluid">
	        <div class="filter-section ms-2 d-flex justify-content-between align-items-center">
	        	
	        	<div class="flex-grow-1 me-3">
	        	
	        		<form class="row align-items-center mb-3" method="get" th:action="@{/products/home}">
				        <!-- Filter By Product Name -->
				        <div class="col-md-3 col-12 mb-2 mb-md-0">
				            <div class="row align-items-center">
				                <div class="col-auto">
				                    <label for="search" class="form-label mb-0">Filter:</label>
				                </div>
				                <div class="col">
				                    <input type="text" class="form-control" placeholder="Search Product" id="searchInput" name="search" th:value="${search}" autocomplete="off">
				                </div>
				            </div>
				        </div>
				        
				        <!-- Filter Per Categories -->
				        <div class="col-md-5 col-12 mb-2 mb-md-0">
				            <div class="row align-items-center">
				                <div class="col-auto">
				                    <label for="categories" class="form-label mb-0">Categories:</label>
				                </div>
				                <div class="col">
				                    <div class="dropdown w-100">
				                        <button class="form-control dropdown-toggle text-start" type="button" data-bs-toggle="dropdown">
				                            <span th:if="${categoriesIds == null or #lists.isEmpty(categoriesIds)}">Categories</span>
				                            <span th:if="${categoriesIds != null and !#lists.isEmpty(categoriesIds)}">
				                                <span th:each="cat, iterStat : ${categories}" 
				                                      th:if="${#lists.contains(categoriesIds, cat.id)}">
				                                    <span th:text="${cat.name}"></span>
				                                    <span th:if="${!iterStat.last}">- </span>
				                                </span>
				                            </span>
				                        </button>
				                        <ul class="dropdown-menu p-3 w-100" style="max-height:250px; overflow-y:auto;">
				                            <li th:each="cat : ${categories}">
				                                <div class="form-check">
				                                    <input class="form-check-input"
				                                           type="checkbox"
				                                           th:id="${cat.id}"
				                                           th:name="categoriesIds"
				                                           th:value="${cat.id}"
				                                           th:checked="${categoriesIds != null and #lists.contains(categoriesIds, cat.id)}"/>
				                                    <label class="form-check-label ms-1" th:for="${cat.id}" th:text="${cat.name}"></label>
				                                </div>
				                            </li>
				                        </ul>
				                    </div>
				                </div>
				            </div>
				        </div>
				        
				        <!-- Buttons -->
				        <div sec:authorize="hasRole('ADMIN')" class="col-md-4 col-12 mt-2 mt-md-0 d-flex">
				            <button type="submit" class="btn btn-outline-dark me-2">Filter</button>
				            <a th:href="@{/products/home}" class="btn btn-outline-secondary me-2">Reset</a>
				        	<button type="button" class="btn btn-outline-dark ms-auto" data-bs-toggle="modal" data-bs-target="#modalAddProduct">
			                    Add Product
			                </button>
				        </div>
				    </form>
				    
	        	</div>
	        	
			</div>
		</div>
        
        <!-- Products List -->
        <div class="container-fluid mt-3">
            
            <!-- Table -->
            <div class="card mb-3">
            	<div class="card-header text-center">
            		<h5>List of Products</h5>
            	</div>
            	<div class="card-body">
            		<div class="table-responsive">
		                <table class="table table-hover text-center">
		                    <thead>
		                        <tr>
		                            <th>Code</th>
		                            <th>Name</th>
		                            <th>Category</th>
		                            <th>Price</th>
		                            <th>Stock</th>
		                            <th>Status</th>
		                            <th>Actions</th>
		                        </tr>
		                    </thead>
		                    <tbody id="productsTableBody">
		                    	<tr th:each="i : ${#numbers.sequence(0, 10)}">
			                        <td th:text="${#lists.size(products.content) > i ? products.content[i].code : '—'}"></td>
			                        <td th:text="${#lists.size(products.content) > i ? products.content[i].name : '—'}"></td>
			                        <td th:text="${#lists.size(products.content) > i ? products.content[i].category.name : '—'}"></td>
			                        <td th:text="${#lists.size(products.content) > i ? products.content[i].priceUnit : '—'}"></td>
			                        <td th:text="${#lists.size(products.content) > i ? products.content[i].stockActual : '—'}"></td>
			                        <td th:text="${#lists.size(products.content) > i ? (products.content[i].active ? 'Active' : 'Inactive') : '—'}"></td>
		                    		<td>
		                    			<div sec:authorize="hasRole('ADMIN')">
			                    			<!-- Edit Button - Only enabld if product exists -->
								        	<button th:if="${#lists.size(products.content) > i}" 
			                            	        type="button" 
			                            	        class="btn btn-sm btn-outline-dark"
			                            	        data-bs-toggle="modal"
			                            	        data-bs-target="#modalEditProduct"
			                            	        th:attr="data-id=${products.content[i].id},
			                                                 data-name=${products.content[i].name},
			                                                 data-code=${products.content[i].code},
			                                                 data-description=${products.content[i].description},
			                                                 data-priceunit=${products.content[i].priceUnit},
			                                                 data-stockactual=${products.content[i].stockActual},
			                                                 data-stockminimum=${products.content[i].stockMinimum},
			                                                 data-categoryid=${products.content[i].category.id},
			                                                 data-active=${products.content[i].active}">
			                                	Edit
								        	</button>
								        	
								        	<!-- Disabled Edit Button for empty rows -->
								        	<button th:if="${#lists.size(products.content) <= i}"
								                    class="btn btn-sm btn-outline-secondary"
								                    disabled>
								                Edit
								        	</button>
								        	
								        	<!-- Delete Button - Only enabled if product exists -->
								            <form th:if="${#lists.size(products.content) > i}"
								            	  th:action="@{/products/delete/{id}(id=${products.content[i].id})}" 
								            	  method="post" 
								            	  style="display:inline;">
											    <button class="btn btn-sm btn-outline-danger" type="submit">Delete</button>
											</form>
											
											<!-- Disabled Delete Button for empty rows -->
											<form th:if="${#lists.size(products.content) <= i}"
												  style="display:inline;">
												<button class="btn btn-sm btn-outline-secondary"
														type="button"
														disabled>Delete</button>
											</form>
										</div>
										
										<div sec:authorize="hasRole('EMPLOYEE')">
											<!-- Edit Button - Disabled for User -->
								        	<button type="button" 
			                            	        class="btn btn-sm btn-outline-dark"
			                            	        disabled>
			                                	Edit
								        	</button>
								        	<!-- Delete Button - Disabled for User -->
											<form style="display:inline;">
												<button class="btn btn-sm btn-outline-secondary"
														type="button"
														disabled>
													Delete
												</button>
											</form>
										</div>
										
		                    		</td>
		                    	</tr>
		                    </tbody>
		                </table>
		            </div>
		            
		            <!-- Pagination -->
		            <nav aria-label="Products pagination" class="mt-3"
		            	th:if="${totalPages > 1 && products.size() > 0}">
		            	<ul class="pagination justify-content-center">
		            		<!-- Previous Button -->
		            		<li th:classappend="${currentPage == 0} ? 'disabled'" class="page-item" >
		            			<a th:href="@{/products/home(
		            						page=${currentPage-1},
		            						search=${search},
		            						categoriesIds=${categoriesIds}
		            						)}" 
		            				class="page-link" 
		            				tabindex="-1">Previous</a>
		            		</li>
		            		<!-- Number of Page -->
		            		<li class="page-item"
		            			th:each="i : ${#numbers.sequence(0, totalPages-1)}"
		            			th:classappend="${i == currentPage} ? 'active'">
		            			<a class="page-link" 
		            			   th:href="@{/products/home(
		            			   			page=${i},
		            			   			search=${search},
		            			   			categoriesIds=${categoriesIds}
		            			   			)}"
		            			   th:text="${i + 1}">1</a>
		            		</li>
		            		<!-- Next Button -->
		            		<li class="page-item" th:classappend="${currentPage == totalPages - 1} ? 'disabled'">
		            			<a class="page-link" th:href="@{/products/home(
		            						page=${currentPage + 1},
		            						search=${search},
		            						categoriesIds=${categoriesIds}
		            						)}">Next</a>
		            		</li>
		            	</ul>
		            </nav>
            	</div>
            </div>	
            
        </div>
    </div>
    
	<!-- Modals -->
	<div th:replace="~{fragments/product-modals :: modal-add-product(${categories}, 'product')}"></div>
	<div th:replace="~{fragments/product-modals :: modal-edit-product(${categories})}"></div>
	
	<!-- Script to show the add product modal if the flag is set -->
	<script th:if="${showAddProductModal}">
	    document.addEventListener('DOMContentLoaded', function() {
	        var modal = new bootstrap.Modal(document.getElementById('modalAddProduct'));
	        modal.show();
	    });
	</script>
	<!-- Script to show the edit product modal if the flag is set -->
	<script th:if="${showEditProductModal}">
        document.addEventListener('DOMContentLoaded', function() {
            var modal = new bootstrap.Modal(document.getElementById('modalEditProduct'));
            modal.show();
        });
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/js/bootstrap.bundle.min.js"></script>
	<script src="/js/modalEditProduct.js"></script>
</body>
</html>