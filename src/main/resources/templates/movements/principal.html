<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Movements - Inventory System</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <!-- Navbar -->
    <div th:replace="~{fragments/navbar :: navbar('movements')}"></div>
    
    <!-- Main Container -->
    <div class="main-container">
		
		<!-- Title -->
        <div class="functions-section">
            <h3 class="m-3">Movements</h3>
        </div>
        
        <!-- Filter Section (List of Movements) -->
        <div class="movements-list">
            <div class="d-flex justify-content-left flex-wrap align-items-center gap-3 m-2">
                <h5 class="m-2">List of Movements</h5>
            </div>
			<div class="d-flex flex-wrap align-items-end gap-2 ms-2 mb-3">
	            <form method="get" th:action="@{/movements/home}">
			        <!-- Filters on the left -->
			        <div class="d-flex flex-wrap gap-2">
			            <!-- Date Range Filter -->
			            <div class="dropdown">
							<button class="btn btn-outline-dark dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
							    <span th:text="${selectedDateLabel}">Date</span>
							</button>
							<div class="dropdown-menu p-3" style="min-width: 260px;">
							    <div class="mb-2">
							        <label class="form-label mb-1">From:</label>
							        <input type="date" class="form-control" name="dateFrom" th:value="${param.dateFrom}">
							    </div>
							    <div>
							        <label class="form-label mb-1">To:</label>
							        <input type="date" class="form-control" name="dateTo" th:value="${param.dateTo}">
							    </div>
							</div>
			            </div>
			            <!-- Type Filter -->
			            <div class="dropdown">
							<button class="btn btn-outline-dark dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
							    <span th:text="${#strings.isEmpty(param.type) ? 'Type' : param.type}">Type</span>
							</button>
							<div class="dropdown-menu p-3" style="min-width: 200px;">
								<select class="form-select" name="type">
								    <option value="">All types</option>
								    <option th:each="type : ${types}"
								            th:value="${type}"
								            th:text="${type}"
								            th:selected="${type} == ${param.type}">
								    </option>
								</select>
							</div>
			            </div>
			            <!-- Product Filter -->
			            <div class="dropdown">
							<button class="btn btn-outline-dark dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
								<span th:text="${selectedProductName}">Product</span>
							</button>
							<div class="dropdown-menu p-3" style="min-width: 200px;">
								<select class="form-select" name="productId">
								    <option value="">All products</option>
								    <option th:each="p : ${products}"
								            th:value="${p.id}"
								            th:text="${p.name}"
								            th:selected="${p.id} == ${param.productId}">
								    </option>
								</select>
							</div>
			            </div>
			            <!-- Filter Button -->
			            <button type="submit" class="btn btn-outline-dark">Filter</button>
			            <a th:href="@{/movements/home}" class="btn btn-outline-secondary">Reset</a>
			        </div>
	        	</form>		
						
				<!-- Button on the right -->
		        <button class="btn btn-outline-dark ms-auto me-3" data-bs-toggle="modal" data-bs-target="#modalAddMovement">
		            Register Movement
		        </button>
			</div>
            
            <!-- Table -->
            <div class="table-responsive ms-2">
                <table class="table table-hover text-center">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Type</th>
                            <th>User</th>
                            <th>Product</th>
                            <th>Amount</th>
                            <th>Unit Price</th>
                            <th>Stock Before</th>
                            <th>Stock After</th>
                            <th>Reason</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="movementsTableBody">
                        <tr th:each="mov : ${movements}">
                            <td th:text="${#temporals.format(mov.movementDate, 'yyyy-MM-dd HH:mm')}"></td>
                            <td th:text="${mov.typeMovement}"></td>
                            <td th:text="${mov.registeredUser}"></td>
                            <td th:text="${mov.product.name}"></td>
                            <td th:text="${mov.amount}"></td>
                            <td th:text="${mov.priceUnit}"></td>
                            <td th:text="${mov.beforeStock}"></td>
                            <td th:text="${mov.afterStock}"></td>
                            <td th:text="${mov.motive}"></td>
                            <td>
                                <!-- Delete action -->
                                <form th:action="@{/movements/delete/{id}(id=${mov.id})}" method="post" style="display:inline;">
                                    <button class="btn btn-sm btn-outline-danger" type="submit">Delete</button>
                                </form>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
			
            <!-- Pagination -->
            <nav aria-label="Movements pagination" class="mt-3">
                <ul class="pagination justify-content-center">
                    <!-- Previous Button -->
                    <li th:classappend="${currentPage == 0} ? 'disabled'" class="page-item" >
                        <a th:href="@{/movements/home(
                                    page=${currentPage-1},
                                    dateFrom=${param.dateFrom},
                                    dateTo=${param.dateTo},
                                    type=${param.type},
                                    userId=${param.userId},
                                    productId=${param.productId}
                                    )}" 
                           class="page-link" 
                           tabindex="-1">Previous</a>
                    </li>
                    <!-- Number of Page -->
                    <li class="page-item"
                        th:each="i : ${#numbers.sequence(0, totalPages-1)}"
                        th:classappend="${i == currentPage} ? 'active'">
                        <a class="page-link" 
                           th:href="@{/movements/home(
                                    page=${i},
                                    dateFrom=${param.dateFrom},
                                    dateTo=${param.dateTo},
                                    type=${param.type},
                                    userId=${param.userId},
                                    productId=${param.productId}
                                    )}"
                           th:text="${i + 1}">1</a>
                    </li>
                    <!-- Next Button -->
                    <li class="page-item" th:classappend="${currentPage == totalPages - 1} ? 'disabled'">
                        <a class="page-link" th:href="@{/movements/home(
                                    page=${currentPage + 1},
                                    dateFrom=${param.dateFrom},
                                    dateTo=${param.dateTo},
                                    type=${param.type},
                                    userId=${param.userId},
                                    productId=${param.productId}
                                    )}">Next</a>
                    </li>
                </ul>
            </nav>
        </div>
    </div>
	
    <!-- Modals -->
    <div th:replace="~{fragments/movements-modals :: modal-add-movement(${products},${types})}"></div> 
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>