<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Movements - Inventory System</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <!-- Navbar -->
    <div th:replace="~{fragments/navbar :: navbar('movements')}"></div>
    
    <!-- Main Container -->
    <div class="main-container">
		
		<!-- Title -->
        <div class="functions-section">
            <h3 class="m-3">Movements</h3>
        </div>
        
        <!-- Filter Section (List of Movements) -->
        <div class="container-fluid">
			<div class="filter-section d-flex justify-content-between align-items-center">
			
				<div class="flex-grow-1 me-3">
					
					<form class="row align-items-center mb-3" method="get" th:action="@{/movements/home}">
				        <!-- Filters on the left -->
				        <div class="d-flex flex-wrap gap-2">
				            <!-- Date Range Filter -->
				            <div class="ms-2">
						        <label class="form-label mb-1 me-2">From:</label>
						        <input type="date" class="form-control d-inline-block w-auto" name="dateFrom" th:value="${dateFrom != null ? #temporals.format(dateFrom, 'yyyy-MM-dd') : ''}">
						        <label class="form-label mb-1 ms-3 me-2">To:</label>
						        <input type="date" class="form-control d-inline-block w-auto" name="dateTo" th:value="${dateTo != null ? #temporals.format(dateTo, 'yyyy-MM-dd') : ''}">
						    </div>
				            <!-- Type Filter -->
				            <div>
						        <select class="form-select" name="type" id="type" style="min-width:120px;">
						            <option value="">All types</option>
						            <option th:each="type : ${types}"
						                    th:value="${type.name()}"
						                    th:text="${type}"
						                    th:selected="${type.name() == selectedType?.name()}">
						            </option>
						        </select>
						    </div>
						    <!-- Product Filter -->
						    <div>
						        <select class="form-select" name="productId" id="productId" style="min-width:120px;">
						            <option value="">All products</option>
						            <option th:each="p : ${products}"
						                    th:value="${p.id}"
						                    th:text="${p.name}"
						                    th:selected="${p.id != null and p.id == productId}">
						            </option>
						        </select>
						    </div>
						    
				            <!-- Filter Button -->
				            <button type="submit" class="btn btn-outline-dark">Filter</button>
				            <a th:href="@{/movements/home}" class="btn btn-outline-secondary">Reset</a><!-- Button on the right -->
					        <button type="button" class="btn btn-outline-dark ms-auto me-3" data-bs-toggle="modal" data-bs-target="#modalAddMovement">
					            Register Movement
					        </button>
				        </div>
		        	</form>	
						
				</div>
			</div>
        </div> 
        <div class="container-fluid mt-3">
            <!-- Table -->
            <div class="card mb-3">
            	<div class="card-header text-center">
            		<h5>List of Movements</h5>
            	</div>
            </div>
           <div class="card-body">
	           	<div class="table-responsive">
	                <table class="table table-hover text-center">
	                    <thead>
	                        <tr>
	                            <th>Date</th>
	                            <th>Type</th>
	                            <th>User</th>
	                            <th>Product</th>
	                            <th>Amount</th>
	                            <th>Unit Price</th>
	                            <th>Stock Before</th>
	                            <th>Stock After</th>
	                            <th>Reason</th>
	                            <th>Actions</th>
	                        </tr>
	                    </thead>
	                    <tbody id="movementsTableBody">
	                        <tr th:each="i : ${#numbers.sequence(0, 10)}">
	                            <td>
						            <span th:if="${#lists.size(movements.content) > i}" 
						                  th:text="${#temporals.format(movements.content[i].movementDate, 'yyyy-MM-dd HH:mm')}"></span>
						            <span th:unless="${#lists.size(movements.content) > i}">—</span>
						        </td>
	        					<td th:text="${#lists.size(movements.content) > i ? movements.content[i].typeMovement : '—'}"></td>
						        <td th:text="${#lists.size(movements.content) > i ? movements.content[i].registeredUser : '—'}"></td>
						        <td th:text="${#lists.size(movements.content) > i ? movements.content[i].product.name : '—'}"></td>
						        <td th:text="${#lists.size(movements.content) > i ? movements.content[i].amount : '—'}"></td>
						        <td th:text="${#lists.size(movements.content) > i ? movements.content[i].priceUnit : '—'}"></td>
						        <td th:text="${#lists.size(movements.content) > i ? movements.content[i].beforeStock : '—'}"></td>
						        <td th:text="${#lists.size(movements.content) > i ? movements.content[i].afterStock : '—'}"></td>
						        <td th:text="${#lists.size(movements.content) > i ? movements.content[i].motive : '—'}"></td>
	                            <td>
						            <!-- Delete Button - Only enabled if movement exists -->
						            <form th:if="${#lists.size(movements.content) > i}" 
						                  th:action="@{/movements/delete/{id}(id=${movements.content[i].id})}" 
						                  method="post" 
						                  style="display:inline;">
						                <button class="btn btn-sm btn-outline-danger" type="submit">Delete</button>
						            </form>
						            
						            <!-- Disabled Delete Button for empty rows -->
						            <form th:if="${#lists.size(movements.content) <= i}" 
						                  style="display:inline;">
						                <button class="btn btn-sm btn-outline-secondary" 
						                        type="button" 
						                        disabled>Delete</button>
						            </form>
						        </td>
	                        </tr>
	                    </tbody>
	                </table>
	            </div>
            
	            <!-- Pagination -->
	            <nav aria-label="Movements pagination" class="mt-3">
	                <ul class="pagination justify-content-center">
	                    <!-- Previous Button -->
	                    <li th:classappend="${currentPage == 0} ? 'disabled'" class="page-item" >
	                        <a th:href="@{/movements/home(
	                                    page=${currentPage-1},
	                                    dateFrom=${dateFrom},
	                                    dateTo=${dateTo},
	                                    type=${selectedType},
	                                    productId=${productId}
	                                    )}" 
	                           class="page-link" 
	                           tabindex="-1">Previous</a>
	                    </li>
	                    <!-- Number of Page -->
	                    <li class="page-item"
	                        th:each="i : ${#numbers.sequence(0, totalPages-1)}"
	                        th:classappend="${i == currentPage} ? 'active'">
	                        <a class="page-link" 
	                           th:href="@{/movements/home(
	                                    page=${i},
	                                    dateFrom=${dateFrom},
	                                    dateTo=${dateTo},
	                                    type=${selectedType},
	                                    productId=${productId}
	                                    )}"
	                           th:text="${i + 1}">1</a>
	                    </li>
	                    <!-- Next Button -->
	                    <li class="page-item" th:classappend="${currentPage == totalPages - 1} ? 'disabled'">
	                        <a class="page-link" th:href="@{/movements/home(
	                                    page=${currentPage + 1},
	                                    dateFrom=${dateFrom},
	                                    dateTo=${dateTo},
	                                    type=${selectedType},
	                                    productId=${productId}
	                                    )}">Next</a>
	                    </li>
	                </ul>
	            </nav>
           </div>
       </div>
           
    </div>
	
    <!-- Modals -->
    <div th:replace="~{fragments/movements-modals :: modal-add-movement(${products},${types},${branches})}"></div> 
    
    <!-- Script to show the add movement modal if the flag is set -->
	<script th:if="${showAddMovementModal}">
	    document.addEventListener('DOMContentLoaded', function() {
	        var modal = new bootstrap.Modal(document.getElementById('modalAddMovement'));
	        modal.show();
	    });
	</script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>